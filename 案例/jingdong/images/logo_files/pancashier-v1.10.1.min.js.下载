!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.pancashier=t()}(this,function(){"use strict";var e="/rest/2.0/membership/product",t="act/api/conf";function r(e){console.dir(e)}function n(e){console.log(e)}function i(e,t,i,o){!function(e){(e=e||{}).type=(e.type||"GET").toUpperCase(),e.dataType=e.dataType||"json",e.async=e.async||!0;var t=[];for(var r in e.data)t.push(encodeURIComponent(r)+"="+encodeURIComponent(e.data[r]));var n=t.join("&"),i=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");i.onreadystatechange=function(){if(4==i.readyState){var t=i.status;t>=200&&t<300?e.success&&e.success(JSON.parse(i.responseText)):e.fail&&e.fail(i.responseText)}},"GET"===e.type.toUpperCase()&&(i.open("GET",e.url+"?"+n,e.async),i.send(null)),"POST"===e.type.toUpperCase()&&(i.open("POST",e.url,e.async),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.send(e.data))}({url:e,type:"GET",data:t,dataType:"json",success:i||r,fail:o||n})}var o={purchase:function(t,r,n){i(e,t,r,n)},amisConfig:function(e,r,n){i(t,e,r,n)}};function a(){this.handlers={}}function s(){return{webqr:1,directqr:1}}function c(){var e=this.purchaseData,t=this.config.qrcodeConf,r=void 0;1==+e.netdisk_pay_channel?(r=e.purchase.codeUrl,this.lifecycle.wxPay()):r=e.purchase.dxmQr.data.shortUrl;var n=document.getElementById(t.element);if(n){if(t.renderInstance&&n===t.eleInstance)return t.renderInstance.clear(),t.renderInstance.makeCode(r),this.lifecycle.QRRendered(),void u.call(this);t.eleInstance=document.getElementById(t.element),t.renderInstance=new QRCode(t.eleInstance,{text:r,width:t.width,height:t.height}),this.lifecycle.QRRendered(),u.call(this)}else this.lifecycle.QRRenderFail()}function u(){var e=this,t=void 0,r=void 0;1==+this.purchaseData.netdisk_pay_channel?(r="/rest/2.0/membership/order",t={business_no:e.purchaseParams.business_no,method:"query"}):(r="/rest/2.0/membership/dxmqr/epic/query/pay",t=e.purchaseData.purchase.dxmQuery),e._queryTimeStart=(new Date).getTime(),e.polling({url:r,params:t,success:function(t){return 1==+e.purchaseData.netdisk_pay_channel?!(!t||!+t.pay_status||1!=+t.pay_status)&&(e.lifecycle.paySuccess(t),e.lifecycle.orderComplete(t),!0):!(!t||!+t.PayStatus||2!=+t.PayStatus)&&(e.lifecycle.paySuccess(t),e.orderQuery(),!0)},fail:function(t){1==+e.purchaseData.netdisk_pay_channel?(e.lifecycle.payError(t),e.lifecycle.orderError(t)):e.lifecycle.payError(t)},queryTime:e.config.payQueryTime,timeout:function(){1==+e.purchaseData.netdisk_pay_channel?(e.lifecycle.orderTimeout(),e.lifecycle.payTimeout()):e.lifecycle.payTimeout()}})}function p(){return{clientinfo:"wap"}}function l(){var e=this.purchaseData;location.href=e.purchase}a.prototype={constructor:a,on:function(e,t){return this.handlers[e]=this.handlers[e]||[],this.handlers[e].push(t),this.handlers[e]},off:function(e){this.handlers[e]&&delete this.handlers[e]},trigger:function(e,t){var r=this,n=t||[],i=this.handlers[e];return!i||i.every(function(e){return!1!==e.apply(r,n)})}};var d=(new function(){this.config={appid:null,debug:!1,defaultFrom:null,paymentType:null,paymentList:["qrcode","h5"],paymentParams:{qrcode:s,h5:p},paymentDispose:{qrcode:c,h5:l},script:{qrcode:"https://staticiot.cdn.bcebos.com/pay/qrcode.min.js",promise:"https://staticiot.cdn.bcebos.com/pay/es6-promise.auto.min.js"},qrcodeConf:{element:null,width:100,height:100,eleInstance:null,renderInstance:null},payQueryTime:24e5,orderQueryTime:5e3,queryOriginStrategy:function(){o.amisConfig({conf_key:"business_payment_sdk"},function(e){try{JSON.parse(e.data[0].conf_value.base)}catch(e){}},function(e){console.log(e)})}}}).config,f={removeElement:function(e){var t=e.parentNode;t&&t.removeChild(e)},loadScript:function(e,t){var r=null,n=document.getElementsByTagName("head")[0];(r=document.createElement("script")).type="text/javascript",r.src=e,"function"==typeof t&&(window.attachEvent?r.onreadystatechange=function(){var e=r.readyState;"loaded"!==e&&"complete"!==e||(r.onreadystatechange=null,t())}:r.onload=t),n.appendChild(r)},stringifyObj:function(e){var t=[];for(var r in e)t.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.join("&")},assign:function(e,t){var r={};for(var n in e)e.hasOwnProperty(n)&&(r[n]=e[n]);for(var i in t)t.hasOwnProperty(i)&&(r[i]=t[i]);return r},typeDecide:function(e,t){return Object.prototype.toString.call(e)==="[object "+t+"]"},isFunction:function(e){return f.typeDecide(e,"Function")},isString:function(e){return f.typeDecide(e,"String")},isArray:function(e){return f.typeDecide(e,"Array")},isObj:function(e){return f.typeDecide(e,"Object")},isReg:function(e){return f.typeDecide(e,"RegExp")},isErrorEvent:function(e){return f.typeDecide(e,"ErrorEvent")},now:function(){return(new Date).getTime()}},h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function y(){var e=this;a.call(this),this.config=d,this.infoQueue=[];for(var t=["log","debug","info","warn","error"],r=function(r){var n=t[r];e[n]=function(t){return e.handleMsg(t,n)}},n=0;n<t.length;n++)r(n)}y.prototype=new a,y.prototype.constructor=y,y.prototype.handleMsg=function(e,t){if(!e)return!1;var r=f.isObj(e)?e:{msg:e};if("object"===h(r.msg)){var n=Object.getOwnPropertyNames(r.msg);n=n.filter(function(e){return"stack"!==e});var i=r.msg.stack;f.isErrorEvent(r.msg)&&(n=["message","error","filename","lineno","colno"]),r.msg=JSON.stringify(r.msg,n),i&&(r.stack=i)}else r.msg=String(r.msg);var o={level:t,time:f.now()};r=f.assign(r,o),this.config.debug?console.log(r):(this.infoQueue.length>=8&&this.infoQueue.shift(),this.infoQueue.push(r),"error"===t&&this.report())},y.prototype.report=function(){var e={time:f.now(),appid:this.config.appid,type:"business-pancashier-error",ua:window.navigator.userAgent,queue:JSON.stringify(this.infoQueue)},t="https://pan.baidu.com/bpapi/analytics?"+f.stringifyObj(e),r=new Image;r.onload=r.onerror=function(){r=null},r.src=t};var m={qrFail:function(e){return["cursor: pointer","width: "+e.width+"px","height: "+e.height+"px","background: #000 url("+e.icon+") center 30px no-repeat","background: rgba(0, 0, 0, "+e.alpha+") url("+e.icon+") center "+(e.height/2-20)+"px no-repeat","background-size: 20px 18px","color: #fff","font-size: 12px","text-align: center","line-height: "+(e.height+20)+"px","-webkit-user-select: none","-moz-user-select: none","-o-user-select: none","user-select: none"].join(";")},qrLoading:function(){return["position: absolute","left: 50%","top: 50%","width: 16px","height: 16px","margin-left: -8px","margin-top: -8px",'background: url("https://staticiot.cdn.bcebos.com/pay/static/ic_loading.gif") no-repeat',"background-size: 16px 16px","font-size: 14px","color: rgb(84, 87, 106)"].join(";")},qrLoadingWrap:function(e){return["width: "+e.width+"px","height: "+e.height+"px",'background: #FFF url("https://staticiot.cdn.bcebos.com/pay/static/ic_loading_bg.png") center center no-repeat',"background-size: 100% 100%"].join(";")}};function g(){var e=this,t=this;y.call(this),this.UI_DOM={qrError:"pancashier_qrcode_error",qrLoadingWrap:"pancashier_qrcode_loading_wrap"},this.positionFix=function(e,t){var r=void 0,n=void 0,i=void 0;try{i=window.getComputedStyle?getComputedStyle(e).position:e.currentStyle.position}catch(e){}if(i&&"static"!==i)try{var o=void 0,a=void 0;window.getComputedStyle?(o=parseInt(getComputedStyle(e)["padding-top"]),a=parseInt(getComputedStyle(e)["padding-left"])):(o=parseInt(e.currentStyle["padding-top"]),a=parseInt(e.currentStyle["padding-left"])),t.style.left=o+"px",t.style.top=a+"px"}catch(e){}else{var s=e.offsetLeft+e.clientLeft,c=e.offsetTop+e.clientTop;r=s-t.offsetLeft+e.clientWidth/2-t.clientWidth/2,n=c-t.offsetTop+e.clientHeight/2-t.clientHeight/2,t.style.marginLeft=r+"px",t.style.marginTop=n+"px"}t.style.position="absolute",t.style.zIndex=e.style.zIndex+9},this.UI={qrErrorShow:function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{target:"qrcode",width:t.config.qrcodeConf.width,height:t.config.qrcodeConf.height,text:"请点击刷新",alpha:.9,icon:"https://staticiot.cdn.bcebos.com/pay/static/ic_refresh_2x.png"};if(!document.getElementById(e.UI_DOM.qrError)){var n=document.createElement("div"),i=document.getElementById(r.target);n.setAttribute("id",e.UI_DOM.qrError),n.setAttribute("style",m.qrFail(r)),n.innerHTML=r.text,n.onclick=function(){t.repay()},i.appendChild(n),t.positionFix(i,n)}},qrErrorRemove:function(){var t=document.getElementById(e.UI_DOM.qrError);t&&f.removeElement(t)},qrLoadingShow:function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{target:"qrcode",width:t.config.qrcodeConf.width,height:t.config.qrcodeConf.height};if(!document.getElementById(e.UI_DOM.qrLoadingWrap)){var n=document.createElement("div");n.setAttribute("id",e.UI_DOM.qrLoadingWrap),n.setAttribute("style",m.qrLoadingWrap(r));var i=document.createElement("i");i.setAttribute("style",m.qrLoading()),n.appendChild(i);var o=document.getElementById(r.target);o.appendChild(n),t.positionFix(o,n)}},qrLoadingRemove:function(){var t=document.getElementById(e.UI_DOM.qrLoadingWrap);t&&f.removeElement(t)}}}g.prototype=new y,g.prototype.constructor=g;var v={init:{success:{status:1001,msg:"初始化-成功"},paramsFail:{status:1002,msg:"初始化-参数校验失败"},fail:{status:1003,msg:"初始化-失败"}},pay:{start:{status:2e3,msg:"支付-开始"}},purchase:{success:{status:2001,msg:"下单-成功"},QRRendered:{status:2002,msg:"下单-二维码渲染成功"},QRRenderFail:{status:2003,msg:"下单-二维码渲染失败"},paramsFail:{status:2004,msg:"下单-参数校验失败"},wxPay:{status:2005,msg:"下单-触发微信直连"},defaultCode:{status:"defaultErrorCode",msg:"未定义的错误码发生"},39514:{status:39514,msg:"身份不符合"},39521:{status:39521,msg:"活动已过期"},36003:{status:36003,msg:"no authority，未登录"},36008:{status:36008,msg:"服务未到期，不能继续购买"},39522:{status:39522,msg:"已经购买过服务, 无法再次购买"},39513:{status:39513,msg:"会员满三年，无法继续购买"}},payStatus:{fail:{status:-1,msg:"支付失败"},success:{status:0,msg:"支付成功"},timeout:{status:-2,msg:"支付超时"}},panStatus:{success:{status:1,msg:"网盘订单完成"},fail:{status:2,msg:"网盘系统错误（待退款 || 待补单）"},timeout:{status:3,msg:"网盘订单超时，暂未回调处理"}}};function q(){var e=this;g.call(e),this.lifecycle={initParamsCheckerFail:function(t){var r=v.init.paramsFail;r.detail=t,"qrcode"===e.config.paymentType&&e.UI.qrErrorShow(),e.trigger("initParamsCheckerFail",[r]),e.userInitFailHandle(r),e.error(r)},initSuccess:function(){var t=v.init.success;"qrcode"===e.config.paymentType&&e.UI.qrErrorRemove(),e.trigger("initSuccess",[t]),e.userInitSuccessHandle(t),e.log(t)},initFail:function(t){var r=v.init.fail;r.detail=t,"qrcode"===e.config.paymentType&&e.UI.qrErrorShow(),e.trigger("initFail",[r]),e.userInitFailHandle(r),e.error(r)},payStart:function(){var t=v.pay.start;"qrcode"===e.config.paymentType&&(e.UI.qrLoadingShow(),e.UI.qrErrorRemove()),e.log(t)},purchaseParamsFail:function(t){var r=v.purchase.paramsFail;r.detail=t,"qrcode"===e.config.paymentType&&(e.UI.qrLoadingRemove(),e.UI.qrErrorShow()),e.trigger("purchaseParamsFail",[r]),e.userPayFailHandle(r),e.error(r)},purchaseSuccess:function(){var t=v.purchase.success;t.detail=e.purchaseData,"qrcode"===e.config.paymentType&&(e.UI.qrLoadingShow(),e.UI.qrErrorRemove()),e.trigger("purchaseSuccess",[t]),e.log(t)},purchaseError:function(t){var r=void 0;try{r=JSON.parse(t).error_code}catch(t){r="defaultCode"}var n=v.purchase[r]||v.purchase.defaultCode;n.detail=t,"qrcode"===e.config.paymentType&&(e.UI.qrLoadingRemove(),e.UI.qrErrorShow()),e.trigger("purchaseError",[t]),e.userPayFailHandle(n),e.error(n)},QRRendered:function(){var t=v.purchase.QRRendered;"qrcode"===e.config.paymentType&&(e.UI.qrLoadingRemove(),e.UI.qrErrorRemove()),e.trigger("QRRendered",[t]),e.log(t)},wxPay:function(){var t=v.purchase.wxPay;e.trigger("wxPay",[t]),e.log(t)},QRRenderFail:function(){var t=v.purchase.QRRenderFail;"qrcode"===e.config.paymentType&&(e.UI.qrLoadingRemove(),e.UI.qrErrorShow()),e.trigger("QRRenderFail",[t]),e.log(t)},paySuccess:function(t){var r=v.payStatus.success;r.detail=t,e.userPaySuccessHandle(r),e.trigger("paySuccess",[r]),e.log(r)},payError:function(t){var r=v.payStatus.fail;r.detail=t,"qrcode"===e.config.paymentType&&(e.UI.qrLoadingRemove(),e.UI.qrErrorShow()),e.trigger("payError",[r]),e.userPayFailHandle(r),e.error(r)},payTimeout:function(){var t=v.payStatus.timeout;"qrcode"===e.config.paymentType&&(e.UI.qrLoadingRemove(),e.UI.qrErrorShow()),e.trigger("payTimeout",[t]),e.userPayFailHandle(t),e.error(t)},orderComplete:function(t){var r=v.panStatus.success;r.detail=t,e.trigger("orderComplete",[r]),e.log(r)},orderError:function(t){var r=v.panStatus.fail;r.detail=t,"qrcode"===e.config.paymentType&&(e.UI.qrLoadingRemove(),e.UI.qrErrorShow()),e.trigger("orderError",[r]),e.error(r)},orderTimeout:function(){var t=v.panStatus.timeout;"qrcode"===e.config.paymentType&&(e.UI.qrLoadingRemove(),e.UI.qrErrorShow()),e.trigger("orderTimeout",[t]),e.warn(t)}}}function S(){q.call(this),this.initStatus=!1,this.purchaseLock=!1,this.purchaseParams=null,this.purchaseData=null,this.userInitSuccessHandle=function(){},this.userInitFailHandle=function(){},this.userPaySuccessHandle=function(){},this.userPayFailHandle=function(){}}q.prototype=new g,q.constructor=q,S.prototype=new q,S.constructor=S,S.prototype.init=function(e){var t=this;this.config.debug=!!e.debug,e.appid&&(this.config.appid=e.appid),e.fail&&(this.userInitFailHandle=e.fail),e.success&&(this.userInitSuccessHandle=e.success),e.from&&(this.config.defaultFrom=e.from),e.payQueryTime&&(this.config.payQueryTime=e.payQueryTime),e.orderQueryTime&&(this.config.orderQueryTime=e.orderQueryTime);try{if(!this.initParamsChecker(e))return;this.config.paymentType=e.paymentType,"qrcode"!==this.config.paymentType||window.QRCode?(this.initStatus=!0,this.lifecycle.initSuccess()):f.loadScript(this.config.script.qrcode,function(){t.initStatus=!0,t.lifecycle.initSuccess()}),Array.indexOf||(Array.prototype.indexOf=function(e){for(var t=0;t<this.length;t++)if(this[t]===e)return t;return-1})}catch(e){this.lifecycle.initFail(e)}},S.prototype.getBusinessNo=function(){return f.now()+""+Math.round(9999*Math.random())},S.prototype.repay=function(){this.lifecycle.payStart(),this.purchaseParams.business_no=this.getBusinessNo(),this.purchase()},S.prototype.pay=function(e){this.initStatus?(e.fail&&(this.userPayFailHandle=e.fail),e.success&&(this.userPaySuccessHandle=e.success),this.purchaseParamsChecker(e)&&("qrcode"===this.config.paymentType&&(this.config.qrcodeConf=f.assign(this.config.qrcodeConf,e.qrcodeConf)),this.purchaseLock||(this.lifecycle.payStart(),this.purchaseLock=!0,clearTimeout(this._queryTimer),this.purchaseParams=this.purchaseParamsFormat(e),this.purchase()))):this.lifecycle.purchaseError("请在初始化完成之后调用支付方法")},S.prototype.destoryPay=function(){clearTimeout(this._queryTimer)},S.prototype.purchase=function(){var e=this;function t(t){e.lifecycle.purchaseError(t),e.purchaseLock=!1}o.purchase(e.purchaseParams,function(r){if(function(e){return!!e.error_code||"h5"===this.config.paymentType&&!e.purchase||1==+e.netdisk_pay_channel&&!e.purchase.codeUrl||!("qrcode"!==this.config.paymentType||1==+e.netdisk_pay_channel||e.purchase&&e.purchase.dxmQr&&e.purchase.dxmQuery)||void 0}.call(e,r))return t(),!1;e.purchaseData=r,e.lifecycle.purchaseSuccess(),e.config.paymentDispose[e.config.paymentType].call(e),e.purchaseLock=!1},t)},S.prototype.initParamsChecker=function(e){return e.appid&&"number"==typeof e.appid?!e.from||"string"==typeof e.from||(this.lifecycle.initParamsCheckerFail("from 类型不为字符串"),!1):(this.lifecycle.initParamsCheckerFail("appid 不存在或者不为number类型"),!1)},S.prototype.purchaseParamsChecker=function(e){return e.product_id&&"string"==typeof e.product_id?e.from&&"string"!=typeof e.from?(this.lifecycle.purchaseParamsFail("from 类型不为字符串"),!1):e.from||this.config.defaultFrom?!!("qrcode"!==e.paymentType||e.qrcodeConf&&f.isObj(e.qrcodeConf))||(this.lifecycle.purchaseParamsFail("qrcodeConf 不存在或者不是一个可使用的对象"),!1):(this.lifecycle.purchaseParamsFail("from 不存在"),!1):(this.lifecycle.purchaseParamsFail("product_id 不存在或类型不为字符串"),!1)},S.prototype.purchaseParamsFormat=function(e){var t=this.config.paymentParams[this.config.paymentType](),r=f.assign(e,{from:e.from||this.config.defaultFrom,method:"purchase",business_no:this.getBusinessNo()}),n=f.assign(t,r);return delete n.qrcodeConf,delete n.success,delete n.fail,n},S.prototype.orderQuery=function(){var e=this,t={business_no:e.purchaseParams.business_no,method:"query"};e._queryTimeStart=f.now(),e.polling({url:"/rest/2.0/membership/order",params:t,success:function(t){return!(!t||!+t.pay_status||1!=+t.pay_status)&&(e.lifecycle.orderComplete(t),!0)},fail:function(t){e.lifecycle.orderError(t)},queryTime:e.config.orderQueryTime,timeout:function(){e.lifecycle.orderTimeout()}})},S.prototype.polling=function(e){var t=this,r=e.url,n=e.params,o=e.success,a=e.fail,s=e.queryTime,c=e.timeout;clearTimeout(t._queryTimer),i(r,n,function(r){if(!o.call(t,r)){var n=f.now()-t._queryTimeStart,i=1e3;switch(!0){case n>s:return void c.call(t);case n>12e5:i=3e3;break;case n>3e5:i=2e3}t._queryTimer=setTimeout(function(){t.polling(e)},i)}},function(e){a.call(t,e)})};var T=new S;return{getInstance:function(){return T},getInstanceStatus:function(){return T.initStatus},init:function(e){return T.init(e)},pay:function(e){return T.pay(e)},repay:function(){return T.repay()},destoryPay:function(){return T.destoryPay()},on:function(e,t){return T.on(e,t)}}});
